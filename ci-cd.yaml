version: '3.9'
services:

#  pushgateway:
#    image: prom/pushgateway
#    restart: always
#    expose:
#      - 9091
#    ports:
#      - "9091:9091"
#    networks:
#      - back-tier
  ngrok: 
    image: wernight/ngrok
    container_name: ngrok-jenkins
    command: ngrok http http://192.168.1.141:8081
    # port for ngrok ui
    ports:
      - 4040:4040
    environment: 
      NGROK_AUTH: 1QLHjKxOEARPFzRgZSsAbAmuo45_5EZUh1F4DCv8tP27NzoB9
      NGROK_DEBUG: "true"
  jenkins:
      image: jenkins-master-docker:1.0.1
      # deploy:
      #   resources:
      #     limits:
      #       # cpus: '1'
      #       memory: 2048M
      #     reservations:
      #       # cpus: '0.25'
      #       memory: 512M
      networks: 
        - ci-cd-network
      privileged: true
      user: root
      restart: unless-stopped
      ports:
        - target: 8080
          published: 8081
          protocol: tcp
          mode: host
      container_name: jenkins
      volumes:
        - /Users/admin/docker-data/jenkins:/var/jenkins_home
        - /var/run/docker.sock:/var/run/docker.sock
        # - /usr/local/bin/docker:/usr/local/bin/docker
      # environment:
      #   - JAVA_OPTS=-Xms512m -Xmx2g -Djava.awt.headless=true

  # sonarqube:
  #     image: sonarqube:8-community
  #     networks: 
  #       - ci-cd-network
  #     container_name: sonarqube
  #     # depends_on:
  #     #   - sonarqube-db
  #     # links:
  #     #   - sonarqube-db
  #     # environment:
  #     #   SONAR_JDBC_URL: jdbc:postgresql://sonarqube-db:5432/sonar
  #     #   SONAR_JDBC_USERNAME: sonar
  #     #   SONAR_JDBC_PASSWORD: sonar
  #     volumes:
  #       - /Users/admin/docker-data/sonarqube/data:/opt/sonarqube/data
  #       - /Users/admin/docker-data/sonarqube/extensions:/opt/sonarqube/extensions
  #       - /Users/admin/docker-data/sonarqube/logs:/opt/sonarqube/logs
  #       - /Users/admin/docker-data/sonarqube/temp:/opt/sonarqube/temp
  #     ports:
  #       - "8082:9000"
  #     restart: always

  # sonarqube-db:
  #   image: postgres:12
  #   container_name: sonarqube-db
  #   networks: 
  #     - ci-cd-network
  #   environment:
  #     POSTGRES_PASSWORD: sonar
  #     SONARQUBE_DB_USER: sonar
  #     SONARQUBE_DB_PASSWORD: sonar
  #     SONARQUBE_DB: sonar
  #   volumes:
  #     - /docker-data/sonarqube/db-data:/var/lib/postgresql

  # artifactory-db:
  #   image: postgres:12
  #   container_name: artifactory-db
  #   networks: 
  #     - ci-cd-network
  #   environment:
  #     POSTGRES_PASSWORD: artifactory
  #     ARTIFACTORY_DB_USER: artifactory
  #     ARTIFACTORY_DB_PASSWORD: artifactory
  #     ARTIFACTORY_DB: artifactory
    # volumes:
    #   - /Users/admin/docker-data/artifactory/db-data:/var/lib/postgresql

  # Artifactory service
  artifactory:
    image: docker.bintray.io/jfrog/artifactory-oss:6.23.13
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 2048M
        reservations:
          cpus:  '0.5'
          memory: 512M
    networks: 
      - ci-cd-network
    container_name: artifactory
    ports:
     - 8087:8081
    volumes:
     - /Users/admin/docker-data/artifactory/data:/var/opt/jfrog/artifactory
#    Add extra Java options by uncommenting the following lines
    environment:
    - EXTRA_JAVA_OPTIONS=-Xms512m -Xmx2g
    restart: always
    ulimits:
      nproc: 65535
      nofile:
        soft: 32000
        hard: 40000

  # Tomcat server
  tomcat:
    image: docker.io/bitnami/tomcat:9.0-debian-10
    deploy:
      resources:
        limits:
          # cpus: '1'
          memory: 2048M
        reservations:
          # cpus: '0.25'
          memory: 512M
    networks: 
      - ci-cd-network
    container_name: tomcat-server
    ports:
     - 8080:8080
    volumes:
     - /Users/admin/docker-data/tomcat:/bitnami
    environment:
      - TOMCAT_ALLOW_REMOTE_MANAGEMENT=1
      - TOMCAT_USERNAME=tomcat
      - TOMCAT_PASSWORD=tomcat

  prometheus:
    image: prom/prometheus:v2.1.0
    networks: 
      - ci-cd-network
    volumes:
      - ./prometheus/:/etc/prometheus/
      - prometheus_data:/prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.console.libraries=/usr/share/prometheus/console_libraries'
      - '--web.console.templates=/usr/share/prometheus/consoles'
    ports:
      - 9090:9090
    links:
      - cadvisor:cadvisor
      - alertmanager:alertmanager
#      - pushgateway:pushgateway
    depends_on:
      - cadvisor
#      - pushgateway
    restart: always
#    deploy:
#      placement:
#        constraints:
#          - node.hostname == ${HOSTNAME}

  node-exporter:
    image: prom/node-exporter
    networks: 
      - ci-cd-network
    volumes:
      - /proc:/host/proc:ro
      - /sys:/host/sys:ro
      - /:/rootfs:ro
    command: 
      - '--path.procfs=/host/proc' 
      - '--path.sysfs=/host/sys'
      - --collector.filesystem.ignored-mount-points
      - "^/(sys|proc|dev|host|etc|rootfs/var/lib/docker/containers|rootfs/var/lib/docker/overlay2|rootfs/run/docker/netns|rootfs/var/lib/docker/aufs)($$|/)"
    ports:
      - 9100:9100
    restart: always
    deploy:
      mode: global

  alertmanager:
    image: prom/alertmanager
    networks: 
      - ci-cd-network
    ports:
      - 9093:9093
    volumes:
      - ./alertmanager/:/etc/alertmanager/
    restart: always
    command:
      - '--config.file=/etc/alertmanager/config.yml'
      - '--storage.path=/alertmanager'
#    deploy:
#      placement:
#        constraints:
#          - node.hostname == ${HOSTNAME}
  cadvisor:
    image: google/cadvisor
    networks: 
      - ci-cd-network
    volumes:
      - /:/rootfs:ro
      - /var/run:/var/run:rw
      - /sys:/sys:ro
      - /var/lib/docker/:/var/lib/docker:ro
    ports:
      - 8085:8080
    restart: always
    deploy:
      mode: global

  grafana:
    image: grafana/grafana
    networks: 
      - ci-cd-network
    user: "472"
    depends_on:
      - prometheus
    ports:
      - 3010:3000
    volumes:
      - grafana_data:/var/lib/grafana
      - ./grafana/provisioning/:/etc/grafana/provisioning/
    env_file:
      - ./grafana/config.monitoring
    restart: always

# container networking
networks:
  ci-cd-network: 
    name: ci-cd-network


